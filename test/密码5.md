# 消息认证码

消息的认证指的是“消息来自正确的发送者”这一属性。也就是确认消息不是由其他人伪装成发送者发出的。<br>
消息认证码简称MAC，是一种确认完整性并进行认证的技术。它可以接受任意长度的消息和一个发送者与接受者之间的共享秘钥，并输出固定长度的数据，这个数据称为MAC值。这里大家可以发现，消息认证码跟单项散列函数很像，都是接受任意长度的消息，生成固定长度的输出。只不过消息认证码需要一个发送者和接受者共享的秘钥。所以大家可以这么理解：消息认证码是一种与秘钥相关的单向散列函数。<br>
## 消息认证码实现方法
1. 使用单向散列函数实现
2. 利用分组密码实现
## HMAC
HMAC是使用单向散列函数来构造消息认证码的方法，任何高强度的单向散列函数都可以用于HMAC。
<br>
**HMAC计算消息认证码的过程：**
1. 填充密钥
如果密钥比单向散列函数单的分组长度短，就需要在末尾填充0，直到密钥长度和单向散列函数分组长度一致；
2. 密钥与ipad进行XOR
ipad是将00110110这一序列不断循环知道达到分组长度形成的比特序列。用填充后的密钥跟ipad进行XOR运算。XOR得到的值称为ipadkey。
3. 与消息结合
把ipadkey的比特序列附加在消息后面。
4. 计算散列值
将（3）得到的比特序列输入单向散列函数，并计算散列值
5. 填充后的秘钥与opad进行XOR计算。
opad是将01011100这一比特序列不断循环直到长度达到分组长度所形成的比特序列。用填充后的密钥和opad进行XOR运算。得到的结果称为opadkey。
6. 组合
把(4)得到的散列值拼在opadkey后面。
7. 计算散列值
把（6）得到的序列输入单向散列函数，并计算散列值，这个散列值就是最终的消息认证码（MAC）
## 重放攻击
主动攻击者可以利用事先保存的争取的MAC值，不断重放来发动攻击：
1. 主动攻击者实现窃听发送者和接受者之间的通信
2. 主动攻击者从A银行向B银行的的账户汇款，A银行根据汇款信息计算出正确的MAC值，并把MAC值和效益一起发送到B银行
3. B银行收到消息并计算出的MAC值，并把计算结果和收到的MAC值进行对比。两个MAC值相等，可以判断是合法的汇款请求。
4. 主动攻击者窃听A银行发送给B银行的消息和MAC值，并保存。
5. 主动攻击者把窃听到的消息和MAC值啊送给B银行
6. B银行把收到的MAC值和计算的MAC进行对比，两个值相等，于是B银行向A银行的账户汇款
7. 城府步骤5和6，主动攻击者就可以获取大量钱财。
在重放攻击过程中，主动攻击者并没有破解消息认证码，只是把A银行的正确的MAC值把存下来，并重复利用。所以这种攻击称为重放攻击。
### 预防重放攻击
- 序号
约定每一次都发送的消息赋予一个递增的编号。
- 时间戳
约定在发送时包含当前的时间，收到以前的信息，及时MAC值正确也当做错误信息处理。
- nonce
在通信之前，接受者先向发送者发送一个一次性的随机数，这个随机数称为nonce,发送者在消息中包含这个nonce并计算MAC值，有一每次发送的nonce不同，所以也就不能进行重放攻击。
## 缺陷
- 接受者Bob接收到来自Alice的消息之后，不能向第三方证明消息来自Alice。
- 接受者B收到包含MAC的消息，可以利用Alice和Bob的密钥计算出来，从而Bob能够确定消息来自Alice，但是Alice可以否认消息来自它。因为没有人可以证实消息确实来自Alice。也就是消息认证码无法防止否认。
# 数字签名
消息认证码可以确定消息是否被村改或者发送者的身份是都被伪装，但是消息认证码不能防止否认。如果发送者不承认发送过消息怎么办呢？数字签名的作用就是防止抵赖。数字签名不具有机密性，它生成的密文仅用于代表只有持有该密钥的人才能够生产的信息，所以数字签名可以直接发送消息明文，用于对比。
## 数字签名的生成和验证
发送者A生成数字签名，接收方B验证数字签名，不过也可以利用第三方来验证数字签名。数字签名对签名密钥和验证密钥进行了区分，签名密钥只有签名的人才持有，验证密钥任何人都可以拥有。
数字签名对签名密钥和验证密钥进行区分，使用验证密钥无法生成密钥。
可以直接对消息签名，也可以对消息的散列值签名。
## 数字签名的方法
- 直接对消息进行签名
1. Alice用自己的私钥对消息进行加密，加密的结果就是生成的数字签名
2. Alice将消息和生成的数字签名发送出去
3. Bob用Alice的公钥对数字签名进行解密
4. Bob将签名解密后的消息和Alice发送的消息进行对比
- 对消息的散列值签名
1. Alice用单项散列函数计算消息的散列值
2. Alice用自己的私钥对消息进行加密，加密的结果就是生成的数字签名
3. Alice将消息和生成的数字签名发送出去
4. Bob用Alice的公钥对数字签名进行解密
5. Bob将签名解密后的消息和Alice发送的消息进行对比
## 通过RSA实现数字签名
签名=消息^D mod N（用RSA生成签名）,签名者的私钥(D,N)。<br>
由签名求得的信息=签名^E mod N（用RSA验证签名），签名者的公钥是（E,N）。
# 证书
公钥证书简称证书，是记载了个人信息和属于个人的公钥。并由认证机构施加数字签名。证书的作用是对公钥的合法性提供证明。只要有证书，我们就知道有认证机构确认该公钥的确属于此人。认证机构就是明确公钥属于此人并生成数字签名的个人或组织。<br>
*证书是怎么工作的*
![](https://github.com/jSomething-for-Nothing/cryptography/blob/master/picture/%E8%AF%81%E4%B9%A6.png)
1. Bob生成秘钥对，并将私钥妥善保管
2. Bob在认证机构注册公钥，请认证机构对公钥加上数字签名
3. 认证机构用自己的私钥对Bob的弓腰施加数字签名并生成证书。
4. Alice得到带有认证机构数字签名的Bob的公钥
5. Alice使用认证机构的公钥验证数字签名，确认Bob公钥的合法性
6. Alice用Bob公钥加密信息并发送给Bob
7. Bob用自己的私钥解密得到消息
## 公钥基础设施
公钥基础设施（PKI）是为了能够更有效地运用公钥制定的一些列规范和规格的总称。并非指某一种规范或规格。
KPI组成要素：用户：使用PKI的人；认证机构：颁发证书的人；仓库：保存证书的数据库。
**认证机构的工作：**
1. 生成秘钥对
生成密钥对有两种方法：一种是KPI自己生成；另一种是认证机构生成。
2. 注册证书。
当用户自行生成密钥对是，用户会请求认证机构来生成证书。生成那个证书时，会使用认证机构的私钥来进行数字签名。
3. 作废证书和CRL
当用户的私钥丢失，被盗时，认证机构需要对证书进行作废。要作废证书，认证机构先要制作一份作废证书清单（CRL）。总的来说，当我们手上有一份证书时，仅凭证书上的认证机构签名和有效期，并不能确定证书是否有效，还需要查询认证机构最新的CRL，看证书是否有效。<br>
## 对证书的攻击：
- 在公钥注册之前进行攻击
- 在施加数字签名前对公钥进行攻击，比如把用来数字签名的公钥替换成主动攻击者的公钥
- 注册相似任命进行攻击、窃取认证机构的私钥进行攻击。
- 攻击者伪装成认证机构进行攻击
- 钻CRL空子进行攻击，从公钥失效到收到CRL需要经过一段时间，可以利用这个时间差发动攻击。
#### X.509证书标准规范
为了统一证书的格式，人们制定了证书规范，其中最广泛使用的就是X.509证书规范。X.509证书大体包含三个部分：
签名前的证书：签名对象信息
数字签名算法：对数字签名是所使用的算法
数字签名：对证书施加的数字签名

## SSL和TLS
SSL/TLS是世界上应用最广泛的密码通信方法，当进行SSL/LTS通信时，Web浏览器上会显示一个小锁头的图标。<br>
我们知道，网络通信都是遵循一种HTTP的协议进行通信，WEB浏览器称为HTTP浏览器，WEB服务器称为HTTP服务器。点击网页浏览器或者输入URL时,web浏览器会通过web浏览器像web服务器发送请求。web服务器则会把页面内容发送给web浏览器，以便对请求做出响应。HTTP可以看做服务器和留恋其之间的进行清酒和相应的规范。<br>
我们用SSL/TLS作为对通信进行加密的协议，再此之上承载HTTP。通过对两种协议进行叠加，就可以对HTTP通信进行加密。除了HTTP协议还可以承载POP,SMTP等多种协议，为它们提供保护。但是密码通信之前和通信之后的数据是不受SSL/TLS协议保护的。<br>
SSL/TLS提供了密码通信的框架，在这个框架中，SSL/TLS中使用的对称密码，公钥密码，单向散列函数等技术都可以自由的替换。可以提供多种工具实现对机密性，完整性和认证的需求。<br>
### TLS
TLS协议由TLS记录协议和TLS握手协议两种协议叠加而成。TLS记录协议在TLS握手协议的下层，负责使用对称密码，对消息进行加密通信，TLS记录协议中使用了对称密码和消息认证码，但是具体的算法和共享密钥是TLS握手协议在服务端和客户端写生决定的。<br>
**TLS握手协议**
TLS握手协议负责出加密外的其他操作，分四个子协议：握手协议，密码规格变更协议，警告协议，应用数据协议。<br>
- 握手协议负责在客户端和服务端之间协商决定密码算法和共享密钥，证书协商生成共性密钥是为了进行密码通信，交换证书是为了通信上方相互进行认证。当服务器和客户端通过握手协议协商一致后，会互发信号来切换密码，负责发出信号的就是密码规格变更协议。
- 密码规格变更协议属于握手协议的一部分，负责向通信对象传达变更密码方式的信号。
- 警告协议负责在发生错误时把错误穿达给对方。
- 应用数据协议负责把TLS上面承载的数据传达给通信对象。
**LTS记录协议**
TLS记录协议负责消息的压缩加密以及数据认证。<br>
1. 首先它会对分割成片段的消息进行压缩，
2. 经过压缩的消息会加上消息认证码。同事为了防止重放攻击，会在计算MAC值时附加片段的编号。
3. 经过压缩的片段和附加的消息认证码会一起通过CBC模式的对称密码加密。
4. 经过上出加密的数据会在加上有苏剧类型，版本号和压缩后的长度组成的报头。
<br>
**主密码**
主密码是TLS客户端和服务端之间协商出来一个秘密数值，他确保了TLS密码通信的机密性和数据认证的可靠性。主密码是客户端和服务器根据预备主机密码，客户端随机数和服务端随机数计算出来的。主密码的功能是生成密码通信过程中使用的密码算法的密钥。<br>

TLS密码技术小结

密码技术|作用|
----| ------|
公钥密码|加密预备密码|
单项散列函数|构成伪随机数生成器|
数字签名|验证服务器和客户端的证书|
伪随机数生成器|生成预备主密码；根据主密码生成密钥；生成初始化向量|

密码技术|作用
----| ---
对称密码（CBC模式）|确保片段的机密性
消息认证码|确保片段的完整性并进行认证
# 密钥
密钥是一个比特序列，它的价值和明文是等价的，因为窃取密钥就可以获取明文。
信息的机密性不能依靠密码算法背身，而是依赖于托栓保管的密钥。
